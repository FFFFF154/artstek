<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Умный zoom на изображении</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        .image-container {
            width: 100vw;
            height: 100vh;
            overflow: scroll;
        }
        #target-image {
            width: 2000px;
            height: 1500px;
            display: block;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        .zoom-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .zoom-indicator.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="image-container">
        <img id="target-image" src="your-image.jpg" alt="Описание">
    </div>
    
    <div class="zoom-indicator" id="zoomIndicator">Масштаб: 100%</div>

    <script>
        const areas = {
            'vn14': { x: 150, y: 500, zoom: 5 },
            'area2': { x: 1200, y: 900, zoom: 3 }
        };

        let currentZoom = 1;
        let lastTapTime = 0;
        const zoomIndicator = document.getElementById('zoomIndicator');
        const img = document.getElementById('target-image');
        const container = document.querySelector('.image-container');

        function zoomToArea(areaKey) {
            const area = areas[areaKey];
            if (!area) return;

            // Сбрасываем к начальному состоянию
            resetZoomImmediately();

            // Даём браузеру время на отрисовку
            setTimeout(() => {
                // Применяем увеличение
                img.style.transform = `scale(${area.zoom})`;
                img.style.transformOrigin = '0 0';
                currentZoom = area.zoom;

                // Ждём следующего frame для применения трансформации
                requestAnimationFrame(() => {
                    // Правильный расчет позиции прокрутки
                    const imgRect = img.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();
                    
                    // Координаты целевой точки на увеличенном изображении
                    const targetX = area.x * area.zoom;
                    const targetY = area.y * area.zoom;
                    
                    // Центр видимой области контейнера
                    const centerX = containerRect.width / 2;
                    const centerY = containerRect.height / 2;
                    
                    // Позиция прокрутки: целевая точка минус половина видимой области
                    const scrollLeft = targetX - centerX;
                    const scrollTop = targetY - centerY;
                    
                    // Ограничиваем прокрутку границами изображения
                    const maxScrollLeft = imgRect.width - containerRect.width;
                    const maxScrollTop = imgRect.height - containerRect.height;
                    
                    container.scrollTo({
                        left: Math.max(0, Math.min(scrollLeft, maxScrollLeft)),
                        top: Math.max(0, Math.min(scrollTop, maxScrollTop)),
                        behavior: 'smooth'
                    });

                    showZoomIndicator(`Масштаб: ${area.zoom}x - ${areaKey}`);
                });
            }, 50);
        }

        function resetZoomImmediately() {
            img.style.transform = 'none';
            img.style.transformOrigin = '0 0';
            currentZoom = 1;
            container.scrollTo({ left: 0, top: 0, behavior: 'auto' });
        }

        function resetZoom() {
            // Плавный сброс
            img.style.transform = 'scale(1)';
            img.style.transformOrigin = '0 0';
            currentZoom = 1;
            
            container.scrollTo({
                left: 0,
                top: 0,
                behavior: 'smooth'
            });
            
            window.location.hash = '';
            showZoomIndicator('Вся картина ✓');
        }

        function showZoomIndicator(text) {
            zoomIndicator.textContent = text;
            zoomIndicator.classList.add('visible');
            
            setTimeout(() => {
                zoomIndicator.classList.remove('visible');
            }, 2000);
        }

        // Альтернативный способ: через абсолютное позиционирование
        function zoomToAreaAlternative(areaKey) {
            const area = areas[areaKey];
            if (!area) return;

            resetZoomImmediately();

            setTimeout(() => {
                const zoomLevel = area.zoom;
                img.style.transform = `scale(${zoomLevel})`;
                img.style.transformOrigin = '0 0';
                currentZoom = zoomLevel;

                // Простой расчет: просто прокручиваем к координатам * zoom
                container.scrollTo({
                    left: area.x * zoomLevel - 100, // Небольшой отступ
                    top: area.y * zoomLevel - 100,
                    behavior: 'smooth'
                });

                showZoomIndicator(`Масштаб: ${zoomLevel}x - ${areaKey}`);
            }, 50);
        }

        // Двойной клик
        img.addEventListener('dblclick', function(e) {
            e.preventDefault();
            resetZoom();
        });

        // Двойной тап
        img.addEventListener('touchend', function(e) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            
            if (tapLength < 300 && tapLength > 0) {
                e.preventDefault();
                resetZoom();
            }
            
            lastTapTime = currentTime;
        });

        // Обработка хэша
        function handleHash() {
            const hash = window.location.hash.substring(1);
            if (areas[hash]) {
                // Пробуем оба метода
                zoomToArea(hash);
                // или: zoomToAreaAlternative(hash);
            } else if (hash === '' && currentZoom !== 1) {
                resetZoom();
            }
        }

        // Дебаг функция: показывать координаты при клике
        img.addEventListener('click', function(e) {
            if (currentZoom === 1) {
                const rect = img.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                console.log('Координаты клика:', Math.round(x), Math.round(y));
                showZoomIndicator(`Координаты: ${Math.round(x)}, ${Math.round(y)}`);
            }
        });

        window.addEventListener('load', handleHash);
        window.addEventListener('hashchange', handleHash);

        window.addEventListener('resize', function() {
            if (currentZoom !== 1) {
                const hash = window.location.hash.substring(1);
                if (areas[hash]) {
                    setTimeout(() => zoomToArea(hash), 100);
                }
            }
        });

        // Для отладки: добавляем кнопки управления
        const debugDiv = document.createElement('div');
        debugDiv.style.position = 'fixed';
        debugDiv.style.bottom = '10px';
        debugDiv.style.left = '10px';
        debugDiv.style.background = 'rgba(0,0,0,0.7)';
        debugDiv.style.padding = '10px';
        debugDiv.style.borderRadius = '5px';
        debugDiv.style.color = 'white';
        debugDiv.innerHTML = `
            <div>Области:</div>
            <button onclick="zoomToArea('vn14')">VN14</button>
            <button onclick="zoomToArea('area2')">Area2</button>
            <button onclick="resetZoom()">Сброс</button>
        `;
        document.body.appendChild(debugDiv);
    </script>
</body>
</html>
